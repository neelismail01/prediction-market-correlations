# Collect Market Prices
#
# Design: Supports two kinds of sync targets:
# 1. Series — syncs all events in a Kalshi series (e.g. KXFEDDECISION).
# 2. Event  — syncs a single event by ticker (for events not part of a tracked series).
#
# Add or remove targets via the matrix.include list below.
# - type: series, ticker: <series_ticker>  → GET /api/kalshi/series/<ticker>
# - type: event,  ticker: <event_ticker>   → GET /api/kalshi/events/<ticker>

name: Collect Market Prices

on:
  schedule:
    # Runs every hour at minute 0 (uses UTC time)
    - cron: '0 * * * *'
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  collect-kalshi-prices:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - type: series
            ticker: KXFEDDECISION
          - type: series
            ticker: KXFED
          - type: series
            ticker: KXINXY
          - type: series
            ticker: KXPRESPERSON
    
    steps:
      - name: Sync Kalshi ${{ matrix.type }} ${{ matrix.ticker }}
        run: |
          if [ "${{ matrix.type }}" = "series" ]; then
            URL="https://prediction-market-correlations.vercel.app/api/sync/kalshi/series/${{ matrix.ticker }}"
          else
            URL="https://prediction-market-correlations.vercel.app/api/sync/kalshi/events/${{ matrix.ticker }}"
          fi
          curl -X POST \
            "$URL" \
            -H "Authorization: Bearer ${{ secrets.COLLECT_KALSHI_PRICES_CRON_JOB_SECRET }}" \
            -s -w "\nHTTP Status: %{http_code}\n" \
            -f
